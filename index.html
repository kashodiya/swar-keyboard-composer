<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swar Keyboard Composer</title>

    <!-- Icon names are here: https://pictogrammers.github.io/@mdi/font/2.0.46/ -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vuetify/2.6.2/vuetify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://webfonts.omenad.net/fonts.css">

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vuetify/2.6.2/vuetify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/3.5.3/vue-router.min.js"></script>

    <!-- WebMidi Docs: https://webmidijs.org/docs/ -->
    <script src="https://cdn.jsdelivr.net/npm/webmidi@next/dist/iife/webmidi.iife.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/distinct-colors@3.0.0/lib/index.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@chroma-cloud/chromajs@0.1.21/dist/chroma.umd.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <!-- For JsZip docs: https://stuk.github.io/jszip/documentation/api_zipobject/async.html -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- jsPDF docs: http://raw.githack.com/MrRio/jsPDF/master/docs/index.html     -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- idb Docs: https://github.com/jakearchibald/idb -->
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <style>
        /* .cur-swar {
            color: red;
            font-size: x-large;
        }

        .viz-container {
            width: 100%;
            background-color: antiquewhite;
            height: 350px;
            overflow: auto;
        }

        .keyboard-swar,
        .swar-bar {
            width: 30px;
            text-align: center;
        }

        .swar-bar {
            background-color: cornsilk;
        }

        .viz-table {
            position: relative;
            margin-left: 20px;
        }

        .swar-line-table {
            top: 160px;
            z-index: 100;
        }

        .keyboard-table {
            top: 150px;
        } */


        .unused-swar {
            color: lightgray;
        }

        .audio-control {
            width: 400px;
        }

        .file-name-input {
            width: 400px;
        }

        ul.swar-list>li {
            display: inline-block;
            height: 52px;
        }

        ul.swar-list {
            padding-left: 0px;
        }




        .piano-keys * {
            box-sizing: border-box
        }

        .piano-keys {
            margin: 0;
        }

        .piano-keys ul {
            height: 12em;
            padding: 1em 0 0 2em;
            position: relative;
            border-radius: 1em;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5) inset, 0 1px rgba(212, 152, 125, 0.2) inset, 0 5px 15px rgba(0, 0, 0, 0.5);
            background: linear-gradient(to bottom right, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0));
        }

        .piano-keys li {
            box-sizing: border-box;
            padding: 0;
            padding-left: 5px;
            list-style: none;
            position: relative;
            float: left;
        }

        code {
            background-color: transparent !important;
            font-weight: bolder !important;
        }

        .piano-keys li>code {
            position: absolute;
            bottom: 0;
            font-weight: bolder;
        }

        .piano-keys li.black>code {
            color: white;
        }

        .piano-keys li>code.not-used {
            color: grey;
        }

        .piano-keys ul .white {
            height: 9em;
            width: 3em;
            z-index: 1;
            border-left: 1px solid #bbb;
            border-bottom: 1px solid #bbb;
            border-radius: 0 0 5px 5px;
            box-shadow: -1px 0 0 rgba(255, 255, 255, 0.8) inset, 0 0 5px #ccc inset, 0 0 3px rgba(0, 0, 0, 0.2);
            background: linear-gradient(to bottom, #eee 0%, #fff 100%)
        }

        .piano-keys ul .white.active-key,
        .piano-keys ul .white:active {
            border-top: 1px solid #777;
            border-left: 1px solid #999;
            border-bottom: 1px solid #999;
            box-shadow: 2px 0 3px rgba(0, 0, 0, 0.1) inset, -5px 5px 20px rgba(0, 0, 0, 0.2) inset, 0 0 3px rgba(0, 0, 0, 0.2);
            background: linear-gradient(to bottom, #fff 0%, #e9e9e9 100%);
        }

        .piano-keys .black.active-key code,
        .piano-keys .black:active code,
        .piano-keys ul .white.active-key code,
        .piano-keys ul .white:active code {
            color: red;
            padding-bottom: 8px;
        }

        .piano-keys .black {
            height: 5em;
            width: 2em;
            margin: 0 0 0 -1em;
            z-index: 2;
            border: 1px solid #000;
            border-radius: 0 0 3px 3px;
            box-shadow: -1px -1px 2px rgba(255, 255, 255, 0.2) inset, 0 -5px 2px 3px rgba(0, 0, 0, 0.6) inset, 0 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #222 0%, #555 100%)
        }

        .piano-keys .black.active-key,
        .piano-keys .black:active {
            box-shadow: -1px -1px 2px rgba(255, 255, 255, 0.2) inset, 0 -2px 2px 3px rgba(0, 0, 0, 0.6) inset, 0 1px 2px rgba(0, 0, 0, 0.5);
            background: linear-gradient(to right, #444 0%, #222 100%);
        }

        .g,
        .a,
        .b,
        .d,
        .e {
            margin: 0 0 0 -1em;
        }

        .piano-keys ul li:first-child {
            border-radius: 5px 0 5px 5px
        }

        .piano-keys ul li:last-child {
            border-radius: 0 5px 5px 5px
        }

        .current-swar {
            color: red !important;
            font-weight: bolder !important;
        }

        .ome-class-name-radio {
            font-size: x-small !important;
        }

        ul.swar-line-vibhag {
            text-align: justify;
            padding-left: 0px;
            padding-right: 4px;
            padding-top: 5px;
            white-space: nowrap;
        }

        ul.swar-line-vibhag:after {
            content: '';
            display: inline-block;
            width: 100%;
        }

        ul.swar-line-vibhag:before {
            content: '';
            display: block;
            margin-top: -1.25em;
        }

        .swar-line-vibhag li {
            display: inline-block;
            margin-right: -.25em;
            position: relative;
            top: 1.25em;
            height: 50px;
        }

        .swar-line-preview {
            border-collapse: collapse;
        }

        .swar-line-preview td {
            border: 2px solid Gray;
        }

        .swar-line-bit-symbol {
            /* font-size: larger !important; */
        }

        .swar-text-area {
            font-family: monospace, Courier, 'Courier New';
        }
    </style>
</head>

<body>

    <div id="app">

        <v-app>
            <v-app-bar app color="deep-purple accent-4" dark>
                <v-toolbar-title style="cursor: pointer" @click="$router.push('/')">
                    Swar Keyboard Composer
                </v-toolbar-title>
                <v-spacer></v-spacer>


                <v-btn small @click="listFiles" class="mr-3">
                    Files
                    <v-icon right>mdi-format-list-bulleted</v-icon>
                </v-btn>

                <v-btn small @click="addNewSwarEdit" class="mr-3">
                    New Swar Editor
                    <v-icon right>mdi-lead-pencil</v-icon>
                </v-btn>


                <v-btn small @click="addNewPlayer" class="mr-3">
                    New Player
                    <v-icon right>mdi-play-circle-outline</v-icon>
                </v-btn>

                <v-btn small @click="addNewRecording">
                    New Recording
                    <v-icon right>mdi-record-rec</v-icon>
                </v-btn>
            </v-app-bar>

            <v-main>
                <v-container fluid>
                    <!-- <Main></Main> -->

                    <router-view></router-view>
                </v-container>
            </v-main>

            <v-footer app>
                Kaushik Ashodiya
            </v-footer>
        </v-app>
    </div>

    <template id="main-template">
        <div>
            <v-snackbar v-model="showMesssage">
                {{message}}
            </v-snackbar>

            <v-tabs show-arrows background-color="deep-purple accent-4" dark v-model="curTab" height="40">
                <v-tab v-for="(tab, tabIndex) in tabs" :key="'tab-' + tabIndex">
                    <h5>
                        {{tab.title}}
                    </h5>
                    <template v-if="tabIndex > 0">
                        <v-spacer class="ml-5"></v-spacer>
                        <v-btn x-small icon @click="closeTab(tabIndex)">
                            <v-icon>mdi-close-circle</v-icon>
                        </v-btn>
                    </template>
                </v-tab>
            </v-tabs>

            <v-tabs-items v-model="curTab">
                <v-tab-item v-for="(tab, tabIndex) in tabs" :key="'tab-body-' + tabIndex">
                    <v-card class="pa-5" outlined>
                        <template v-if="tabIndex == 0">
                            <div>
                                <Welcome></Welcome>
                            </div>
                        </template>
                        <template v-else>
                            <div v-if="tab.type == 'rec'">
                                <Recorder :ref="tab.type + '-' + tabIndex" :tab-index="tabIndex"></Recorder>
                            </div>
                            <div v-if="tab.type == 'play'">
                                <Player :ref="tab.type + '-' + tabIndex" :tab-index="tabIndex" :context="tab.context">
                                </Player>
                            </div>
                            <div v-if="tab.type == 'swarEdit'">
                                <Swaredit :ref="tab.type + '-' + tabIndex" :name="tab.context.name"
                                    :swar-txt="tab.context.swarTxt" :tab-index="tabIndex"></Swaredit>
                            </div>
                        </template>
                    </v-card>
                </v-tab-item>
            </v-tabs-items>

            <!-- Dialog to show files -->
            <v-dialog v-model="showFileDialog" scrollable max-width="700px">
                <v-card>
                    <v-card-title>Files</v-card-title>
                    <v-divider></v-divider>
                    <v-card-text style="height: 500px;">



                        <v-data-table @click:row="fileTableRowClicked" disable-pagination fixed-header
                            hide-default-footer :headers="fileListHeaders" :items="filesList" sort-by="modifiedDate"
                            class="elevation-1">


                            <template v-slot:top>
                                <v-toolbar flat dense style="padding-top: 12px;">
                                    <!-- <v-toolbar-title>Filter type</v-toolbar-title>
                                    <v-divider class="mx-4" inset vertical></v-divider> -->
                                    <v-spacer></v-spacer>

                                    <!-- <v-toolbar-items> -->
                                    <v-radio-group XXv-model="row" row>
                                        <v-radio label="Recordings" value="Recordings"></v-radio>
                                        <v-radio label="Editors" value="Editors"></v-radio>
                                        <v-radio label="Players" value="Players"></v-radio>
                                    </v-radio-group>
                                    <!-- </v-toolbar-items> -->
                                </v-toolbar>
                                <v-divider class="mx-4" XXinset></v-divider>
                            </template>



                            <template v-slot:item.actions="{ item }">
                                <v-tooltip left>
                                    <template v-slot:activator="{ on, attrs }">
                                        <v-icon small class="mr-2" @click="openTabForRecord(item)" v-bind="attrs"
                                            v-on="on">
                                            mdi-folder-open
                                        </v-icon>
                                    </template>
                                    <span>Open</span>
                                </v-tooltip>

                                <v-tooltip right>
                                    <template v-slot:activator="{ on, attrs }">
                                        <v-icon small @click="deleteRecord(item)" v-bind="attrs" v-on="on">
                                            mdi-delete
                                        </v-icon>
                                    </template>
                                    <span>Delete</span>
                                </v-tooltip>
                            </template>
                            <template v-slot:no-data>
                                <h3>No files found. Create something new!</h3>
                            </template>
                        </v-data-table>
                    </v-card-text>
                </v-card>
            </v-dialog>
        </div>
    </template>

    <template id="welcome-template">
        <div ref="welcome-template-body" v-html="bodyHTML">
        </div>
    </template>

    <template id="recorder-template">
        <div>
            <p>
                <v-btn :disabled="!(mediaRecorderCreated && recState == 'NOT-RECORDING')" @click="startRecording">Start
                    Recording</v-btn>
                <v-btn :disabled="recState != 'RECORDING'" @click="stopRecording">Stop Recording</v-btn>
                <v-btn :disabled="recState != 'STOPPED'" @click="clearAll">Clear all</v-btn>
            </p>
            <p XXv-show="audioDataReady">
                <audio id="recordingAudio" ref="recordingAudio" controls class="audio-control"></audio>
            </p>

            <p>
                <v-btn :disabled="!audioDataReady" @click="download">Download</v-btn>
                <v-btn :disabled="!audioDataReady" @click="openInPlayer">Open in Player</v-btn>
            </p>

            <p>
                <v-form ref="form" @submit.prevent="download">
                    <v-text-field class="file-name-input" :rules="[rules.required]" v-model="projectName"
                        label="Project name"></v-text-field>
                </v-form>
            </p>

            <ul class="swar-list">
                <li @click="swarTimeDataItemClicked(d)" v-for="d in swarTimeData">
                    <code class="ome-bhatkhande-english">{{d.swar}}</code>
                </li>
            </ul>
        </div>
    </template>

    <template id="player-template">
        <div>
            <v-file-input v-model="chosenFile" label="Upload zip file"></v-file-input>
            <audio ref="playerAudio" controls></audio>

            <p v-if="swarTimeData != null">
            <ul class="swar-list">
                <li @click="swarTimeDataItemClicked(d)" v-for="(d, index) in swarTimeData">
                    <code class="ome-bhatkhande-english" :ref="'player-swar-' + index">{{d.swar}}</code>

                </li>
            </ul>
            <v-btn @click="openFormatSwars" x-small v-if="swarTimeData != null">Format swars</v-btn>

            <v-btn @click="clearSwarHighlights" x-small>clearSwarHighlights</v-btn>

            </p>

            <!-- Credits to piano css: https://codepen.io/zastrow/pen/kxdYdk -->
            <div class="piano-keys" v-show="pianoKeysInUse.length > 0" ref="pianoKeys">
                <ul class="set">
                    <li :class="k.liClass" :data-key-index="k.keyIndex" v-for="k in pianoKeysInUse"
                        :ref="'piano-key-' + k.keyIndex">
                        <code :class="'ome-bhatkhande-english ' + (k.notUsed ? 'not-used' : '')">{{k.swar}}</code>
                    </li>
                </ul>
            </div>
        </div>
    </template>

    <template id="swaredit-template">
        <div>
            <v-switch v-model="showGuide" label="Show guide"></v-switch>

            <div v-show="showGuide">
                <h3>Swar formatting</h3>
                <p>
                <ul>
                    <li>
                        Each aavertan on new line
                    </li>
                    <li>
                        Each vibhag seperated by a '|'' (pipe)
                    </li>
                    <li>
                        Each bit seperated by a space
                    </li>
                    <li>
                        Read guide for swar keys and other symbols <a href="https://omenad.github.io/fonts/"
                            target="_blank">here</a>
                    </li>
                </ul>
                </p>
                <p>
                <h4>Tips:</h4>
                <ul>
                    <li>
                        Use '=' (3 dots) to indicate continuation of previous bit/swar.
                    </li>
                    <li>
                        Use '-' (underscore) for empty bit/swar.
                    </li>
                </ul>
                </p>

            </div>

            <v-textarea class="mb-3 swar-text-area" hide-details outlined label="Swar lines" v-model="formattedSwars">
            </v-textarea>

            <p>
            <table class="swar-line-preview mb-3" ref="swar-line-preview-table">
                <tr v-for="(line, lineIndex) in swarLines">
                    <td v-for="(vibhag, vibhagIndex) in line">
                        <ul class="swar-line-vibhag">
                            <li v-for="(bitInfo, bitIndex) in vibhag"
                                :ref="'bit-' + lineIndex + '-' + vibhagIndex + '-' + bitIndex">
                                <code :class="bitInfo.isOmenad ? omeClassName : 'swar-line-bit-symbol'"
                                    v-html="bitInfo.symbol">
                                </code>
                            </li>
                        </ul>
                    </td>
                </tr>
            </table>
            <v-btn x-small @click="adjustBitGap(swarLineBitsGapIncrement)">Increase Gap</v-btn>
            <v-btn x-small @click="adjustBitGap(swarLineBitsGapIncrement * -1)">Decrease Gap</v-btn>

            </p>

            <v-btn @click="saveRecord(true)" x-small>Download zip</v-btn>

            <v-switch v-model="allowLyricsLines" label="Allow lyrics lines before swar lines"></v-switch>

            <v-divider class="mt-5 mb-5"></v-divider>

            <h4>Preview</h4>

            Use fonts/language:
            <v-radio-group row v-model="omeClassName">
                <v-radio class="ome-class-name-radio" v-for="oc in omeClassNames" :key="oc.className" :label="oc.title"
                    :value="oc.className"></v-radio>
            </v-radio-group>

            <v-divider class="mt-5 mb-5"></v-divider>
        </div>
    </template>

    <script src="main.js"></script>
</body>

</html>